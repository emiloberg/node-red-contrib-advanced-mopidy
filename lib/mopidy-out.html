<script type="text/x-red" data-template-name="mopidy-out">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-tag"></i> Server</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="mopidy-methods-categories"><i class="fa fa-tag"></i> Category</label>
        <select id="mopidy-methods-categories"></select>
    </div>
    <div class="form-row">
        <label for="mopidy-methods-methods"><i class="fa fa-tag"></i> Method</label>
        <select id="mopidy-methods-methods"></select>
    </div>

    <input type="hidden" id="node-input-params" />
    <!--
    <div class="form-row">
        <label for="node-input-param1"><i class="fa fa-tag"></i> Param 1</label>
        <input type="text" id="node-input-param1" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-input-param2"><i class="fa fa-tag"></i> Param 2</label>
        <input type="text" id="node-input-param1" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-input-param3"><i class="fa fa-tag"></i> Param 3</label>
        <input type="text" id="node-input-param1" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-input-param4"><i class="fa fa-tag"></i> Param 4</label>
        <input type="text" id="node-input-param1" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-input-param5"><i class="fa fa-tag"></i> Param 5</label>
        <input type="text" id="node-input-param1" placeholder="">
    </div>
    -->
</script>

<script type="text/x-red" data-help-name="mopidy-out">
    <p>Some help here</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('mopidy-out',{
        category: 'advanced-input',
        color:'#fdf0c2',
        defaults: {
            name: {value:''},
            server: {value:'', type:'mopidy-config'},
            params: { value: ''}
        },
        inputs:1,
        outputs:1,
        icon: 'white-globe.png',
        label: function() {
            return this.name || this.host || 'mopidy';
        },
        labelStyle: function() {
            return this.name?'node_label_italic':'';
        },

        oneditprepare: function() {
            var allMethods = [];
            var jqMopidyMethodsCategories = $('#mopidy-methods-categories');
            var jqMopidyMethodsMethods = $('#mopidy-methods-methods');

            function populateMethods() {
                var selectedCategory = jqMopidyMethodsCategories.val();
                var htmlMethods = '';
                allMethods.forEach(function(method) {
                   if (method.category === selectedCategory) {
                       htmlMethods += '<option value="' + method.method + '">' + method.method + '</option>';
                   }
                });
                jqMopidyMethodsMethods.html(htmlMethods);
            }
            jqMopidyMethodsCategories.change(populateMethods.bind(this));


            function populateCategories(methods) {
                var htmlCategories = '';
                getUniqueCatgories(methods).forEach(function(category) {
                    htmlCategories += '<option value="' + category + '">' + category + '</option>';
                });
                $('#mopidy-methods-categories').html(htmlCategories);
                populateMethods();
            }

            function getUniqueCatgories(methods) {
                return methods.map(function(method) {
                    return method.category
                })
                .reduce(function(prev, cur) {
                    if (prev.indexOf(cur) === -1) {
                        return prev.concat(cur);
                    } else {
                        return prev;
                    }
                }, [])
                .sort();
            }

            var fetchMethods = debounce(function() {
                var serverNodeId = $('#node-input-server').val();
                if (serverNodeId === '_ADD_') { return; }
                var jqXHR = $.ajax('/mopidy/' + serverNodeId + '/methods', {
                    type: 'GET'
                });

                jqXHR.done(function(data) {
                    allMethods = data;
                    populateCategories(data);
                });

                jqXHR.fail(function(err) {
                    RED.notify('<strong>Mopidy error (err: 1)</strong> Could not get methods (' + err.message + ')' , 'error');
                });
            }, 100);
            $('#node-input-server').change(fetchMethods.bind(this));

            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            }

        }
    });
</script>
