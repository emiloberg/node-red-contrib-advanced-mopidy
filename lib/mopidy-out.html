<script type="text/x-red" data-template-name="mopidy-out">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-tag"></i> Server</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="mopidy-out">
    <p>Some help here</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('mopidy-out',{
        category: 'advanced-input',
        color:'#fdf0c2',
        defaults: {
            name: {value:''},
            server: {value:'', type:'mopidy-config'}
        },
        inputs:1,
        outputs:1,
        icon: 'white-globe.png',
        label: function() {
            return this.name || this.host || 'mopidy';
        },
        labelStyle: function() {
            return this.name?'node_label_italic':'';
        },

        oneditprepare: function() {
            RED.comms.subscribe('mopidy-methods', function(topic, data) {
                console.dir(data);
            });

            var fetchMethods = debounce(function() {
                var serverNodeId = $('#node-input-server').val();
                if (serverNodeId === '_ADD_') { return; }
                var jqXHR = $.ajax('/mopidy/' + serverNodeId + '/methods', {
                    type: 'GET'
                });
                jqXHR.fail(function() {
                    RED.notify('<strong>Mopidy error (err: 1)</strong> Could not get methods', 'error');
                });
            }, 100);
            $('#node-input-server').change(fetchMethods.bind(this));

            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            }

        }
    });
</script>
